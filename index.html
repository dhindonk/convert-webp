<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG/JPG to WebP Converter - Privacy First</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <!-- Meta Description -->
    <meta name="description"
        content="Convert gambar ke WebP gratis dan aman. Free online image to WebP converter ‚Äî 100% private, no upload, browser-based conversion. Support JPG, PNG, GIF, and more." />

    <!-- Meta Keywords -->
    <meta name="keywords"
        content="convert webp, konversi gambar ke webp, image to webp, jpg to webp, png to webp, gif to webp, webp converter gratis, free webp converter, ubah gambar ke webp, online image converter, kompres gambar webp" />

    <!-- Canonical -->
    <link rel="canonical" href="https://convert-webp.pages.dev/" />

    <!-- Language (Multi) -->
    <meta http-equiv="Content-Language" content="id,en" />

    <!-- Author -->
    <meta name="author" content="Fahdin" />

    <!-- Robots -->
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Convert Gambar ke WebP Gratis | Free Image to WebP Converter" />
    <meta property="og:description"
        content="Konversi gambar ke WebP tanpa upload. Convert images to WebP for free, 100% private and secure." />
    <meta property="og:url" content="https://convert-webp.pages.dev/" />
    <meta property="og:image" content="https://convert-webp.pages.dev/assets/og-image.webp" />
    <meta property="og:site_name" content="WebP Converter Online" />
 
    <!-- FAVICON -->
    <link rel="icon" href="assets/favicon.ico" />
    <link rel="apple-touch-icon" href="/assets/favicon.ico" />

    <!-- THEME COLOR -->
    <meta name="theme-color" content="#ffffff" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 1.5rem;
        }

        .privacy-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        .privacy-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 25px;
            border: 1px solid #e2e8f0;
            font-size: 0.9rem;
            color: #059669;
            font-weight: 600;
        }

        .privacy-badge i {
            font-size: 1.2rem;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 2rem;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        .upload-icon {
            font-size: 3rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .file-input {
            display: none;
        }

        .stats {
            display: flex;
            gap: 1rem;
        }

        .stat-card {
            text-align: center;
        }

        .stat-number {
            /* font-size: 2rem; */
            font-weight: 700;
            color: #619cf9;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.1rem;
        }

        .controls {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .quality-control {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quality-slider {
            width: 150px;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }

        .quality-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .quality-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e1;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reconvert-notice {
            background: #fef3c7;
            color: #92400e;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            border-left: 4px solid #f59e0b;
            display: none;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            position: relative;
        }

        .result-card.needs-reconvert {
            border-color: #f59e0b;
        }

        .reconvert-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #f59e0b;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .result-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .result-info {
            padding: 1rem;
        }

        .result-filename {
            font-weight: 600;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .result-sizes {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .size-reduction {
            color: #059669;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .success-message {
            background: #f0fdf4;
            color: #059669;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .storage-info {
            background: #f0f9ff;
            color: #1e40af;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .footer-contact {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            font-size: 0.8rem;
            color: #64748b;
            z-index: 1000;
        }

        .footer-contact a {
            color: #3b82f6;
            text-decoration: none;
            margin: 0 0.25rem;
        }

        .footer-contact a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding-top: 50px;
                margin-bottom: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .privacy-badges {
                align-items: center;
                margin-bottom: 0;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .quality-control {
                justify-content: center;
            }

            .footer-contact {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 2rem;
                text-align: center;
            }
        }
    </style>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-NMFSW9D9');</script>
    <!-- End Google Tag Manager -->
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NMFSW9D9" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div class="container">
        <div class="header">
            <h1>PNG/JPG to WebP Converter</h1>
            <p>Konversi gambar ke format WebP dengan kualitas tinggi, langsung di browser Anda</p>

            <div class="privacy-badges">
                <div class="privacy-badge">
                    <i class='bx bx-shield-check'></i>
                    <span>100% Privacy</span>
                </div>
                <div class="privacy-badge">
                    <i class='bx bx-server'></i>
                    <span>No Server</span>
                </div>
                <div class="privacy-badge">
                    <i class='bx bx-data'></i>
                    <span>Local Storage</span>
                </div>
                <div class="privacy-badge">
                    <i class='bx bx-lock-alt'></i>
                    <span>Data Aman</span>
                </div>
            </div>
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon"><i class='bx bx-cloud-upload'></i></div>
            <div class="upload-text">Drag & drop gambar di sini</div>
            <div class="upload-subtext">atau klik untuk memilih file (PNG, JPG, JPEG - max 10MB per file)</div>
            <input type="file" id="fileInput" class="file-input" multiple accept="image/png,image/jpeg,image/jpg">
        </div>

        <div class="controls" id="controls">
            <div class="quality-control">
                <label for="qualitySlider">Kualitas WebP:</label>
                <input type="range" id="qualitySlider" class="quality-slider" min="0.1" max="1" step="0.05"
                    value="0.95">
                <span id="qualityValue">0.95</span>
            </div>
            <button class="btn btn-primary" id="convertBtn" disabled>
                <i class='bx bx-refresh'></i> Konversi ke WebP
            </button>
            <button class="btn btn-secondary" id="downloadAllBtn" disabled>
                <i class='bx bx-package'></i> Download Semua ZIP
            </button>
            <button class="btn btn-secondary" id="clearBtn">
                <i class='bx bx-trash'></i> Hapus Semua
            </button>

            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">Total File</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="convertedFiles">0</div>
                    <div class="stat-label">Berhasil Dikonversi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSavings">0%</div>
                    <div class="stat-label">Rata2 hemat</div>
                </div>
            </div>
        </div>

        <div class="reconvert-notice" id="reconvertNotice">
            <i class='bx bx-info-circle'></i>
            Kualitas WebP telah diubah. Klik "Konversi ke WebP" untuk mengkonversi ulang dengan kualitas baru.
        </div>

        <div id="messages"></div>

        <div class="results" id="results"></div>
    </div>

    <div class="footer-contact">
        <div>
            Made with ‚ù§Ô∏è by <strong>Moch. Fahdin</strong><br>
            <a href="https://www.linkedin.com/in/moch-fahdin-453b0a286/" target="_blank"><i class='bx bxl-linkedin'></i>
                LinkedIn</a>
            <a href="https://github.com/dhindonk/" target="_blank"><i class='bx bxl-github'></i> GitHub</a>
        </div>
    </div>

    <script>
        class WebPConverter {
            constructor() {
                this.files = [];
                this.convertedFiles = [];
                this.quality = 0.95;
                this.lastConvertedQuality = null;

                this.initializeEventListeners();
                this.loadFromStorage();
            }

            initializeEventListeners() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                const qualitySlider = document.getElementById('qualitySlider');
                const qualityValue = document.getElementById('qualityValue');
                const convertBtn = document.getElementById('convertBtn');
                const downloadAllBtn = document.getElementById('downloadAllBtn');
                const clearBtn = document.getElementById('clearBtn');

                // Upload area events
                uploadArea.addEventListener('click', () => fileInput.click());
                uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
                uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
                uploadArea.addEventListener('drop', this.handleDrop.bind(this));

                // File input
                fileInput.addEventListener('change', this.handleFileSelect.bind(this));

                // Quality slider
                qualitySlider.addEventListener('input', (e) => {
                    this.quality = parseFloat(e.target.value);
                    qualityValue.textContent = this.quality.toFixed(2);
                    this.checkForQualityChange();
                });

                // Buttons
                convertBtn.addEventListener('click', this.convertAllFiles.bind(this));
                downloadAllBtn.addEventListener('click', this.downloadAllAsZip.bind(this));
                clearBtn.addEventListener('click', this.clearAll.bind(this));

                // Save to storage on page unload
                window.addEventListener('beforeunload', () => {
                    this.saveToStorage();
                });

                // Auto-save every 30 seconds
                setInterval(() => {
                    this.saveToStorage();
                }, 30000);
            }

            handleDragOver(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                document.getElementById('uploadArea').classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                this.processFiles(files);
            }

            handleFileSelect(e) {
                const files = Array.from(e.target.files);
                this.processFiles(files);
            }

            processFiles(files) {
                const validFiles = files.filter(file => {
                    const isValidType = ['image/png', 'image/jpeg', 'image/jpg'].includes(file.type);
                    const isValidSize = file.size <= 10 * 1024 * 1024; // 10MB

                    if (!isValidType) {
                        this.showMessage(`File ${file.name} bukan format yang didukung (PNG/JPG)`, 'error');
                        return false;
                    }

                    if (!isValidSize) {
                        this.showMessage(`File ${file.name} terlalu besar (max 10MB)`, 'error');
                        return false;
                    }

                    return true;
                });

                if (validFiles.length > 0) {
                    this.addFiles(validFiles);
                    // this.showMessage(`${validFiles.length} file berhasil dimuat`, 'success');
                    // this.showStorageInfo();
                }
            }

            addFiles(newFiles) {
                newFiles.forEach(file => {
                    let fileName = file.name;
                    let counter = 1;

                    while (this.files.some(f => f.name === fileName)) {
                        const nameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
                        const ext = file.name.split('.').pop();
                        fileName = `${nameWithoutExt}_${counter}.${ext}`;
                        counter++;
                    }

                    const fileObj = {
                        id: Date.now() + Math.random(),
                        file: file,
                        name: fileName,
                        originalSize: file.size,
                        converted: false,
                        webpBlob: null,
                        webpSize: 0,
                        progress: 0,
                        convertedAt: null,
                        convertedQuality: null,
                        needsReconvert: false
                    };

                    this.files.push(fileObj);
                });

                this.updateUI();
                this.saveToStorage();

                // Scroll to results area
                const controlsContainer = document.getElementById('controls');
                if (controlsContainer) {
                    controlsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            checkForQualityChange() {
                if (this.lastConvertedQuality !== null && this.lastConvertedQuality !== this.quality) {
                    // Mark converted files as needing reconversion
                    let needsReconvert = false;
                    this.files.forEach(fileObj => {
                        if (fileObj.converted && fileObj.convertedQuality !== this.quality) {
                            fileObj.needsReconvert = true;
                            needsReconvert = true;
                        }
                    });

                    if (needsReconvert) {
                        document.getElementById('reconvertNotice').style.display = 'block';
                        document.getElementById('convertBtn').className = 'btn btn-warning';
                        document.getElementById('convertBtn').innerHTML = '<i class="bx bx-refresh"></i> Konversi Ulang dengan Kualitas Baru';
                    }

                    this.updateUI();
                }
            }

            updateUI() {
                const totalFiles = this.files.length;
                const convertedFiles = this.files.filter(f => f.converted && !f.needsReconvert).length;

                // Update stats
                if (totalFiles > 0) {
                    document.getElementById('stats').style.display = 'flex';
                    document.getElementById('totalFiles').textContent = totalFiles;
                    document.getElementById('convertedFiles').textContent = convertedFiles;

                    const validConvertedFiles = this.files.filter(f => f.converted && !f.needsReconvert);
                    if (validConvertedFiles.length > 0) {
                        const totalSavings = validConvertedFiles.reduce((acc, file) => {
                            const savings = ((file.originalSize - file.webpSize) / file.originalSize) * 100;
                            return acc + savings;
                        }, 0);
                        document.getElementById('totalSavings').textContent = Math.round(totalSavings / validConvertedFiles.length) + '%';
                    }
                } else {
                    document.getElementById('stats').style.display = 'none';
                }

                // Update buttons
                document.getElementById('convertBtn').disabled = totalFiles === 0;
                document.getElementById('downloadAllBtn').disabled = convertedFiles === 0;

                // Update converted files array for download
                this.convertedFiles = this.files.filter(f => f.converted && !f.needsReconvert);

                // Render results
                this.renderResults();
            }

            renderResults() {
                const resultsContainer = document.getElementById('results');
                resultsContainer.innerHTML = '';

                this.files.forEach(fileObj => {
                    const card = document.createElement('div');
                    card.className = `result-card ${fileObj.needsReconvert ? 'needs-reconvert' : ''}`;

                    const reconvertIndicator = fileObj.needsReconvert ?
                        '<div class="reconvert-indicator">Perlu Konversi Ulang</div>' : '';

                    card.innerHTML = `
                        ${reconvertIndicator}
                        <img class="result-image" src="${URL.createObjectURL(fileObj.file)}" alt="${fileObj.name}">
                        <div class="result-info">
                            <div class="result-filename">${fileObj.name.replace(/\.[^/.]+$/, ".webp")}</div>
                            <div class="result-sizes">
                                <span>Original: ${this.formatFileSize(fileObj.originalSize)}</span>
                                ${fileObj.converted && !fileObj.needsReconvert ? `<span>WebP: ${this.formatFileSize(fileObj.webpSize)}</span>` : ''}
                            </div>
                            ${fileObj.converted && !fileObj.needsReconvert && fileObj.originalSize > fileObj.webpSize ?
                            `<div class="size-reduction">Penghematan: ${Math.round(((fileObj.originalSize - fileObj.webpSize) / fileObj.originalSize) * 100)}%</div>` :
                            ''
                        }
                            ${fileObj.converted && !fileObj.needsReconvert ?
                            `<div style="font-size: 0.8rem; color: #64748b; margin-bottom: 0.5rem;">Kualitas: ${(fileObj.convertedQuality * 100).toFixed(0)}%</div>` :
                            ''
                        }
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${fileObj.progress}%"></div>
                            </div>
                            ${fileObj.converted && !fileObj.needsReconvert ?
                            `<button class="btn btn-primary" onclick="converter.downloadSingle('${fileObj.id}')">
                                    <i class='bx bx-download'></i> Download
                                </button>` :
                            fileObj.needsReconvert ?
                                `<span style="color: #f59e0b; font-weight: 600;"><i class='bx bx-info-circle'></i> Konversi ulang diperlukan</span>` :
                                `<span style="color: #64748b;"><i class='bx bx-time'></i> Menunggu konversi...</span>`
                        }
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                });
            }

            async convertAllFiles() {
                // Scroll to results area
                const resultsContainer = document.getElementById('results');
                if (resultsContainer) {
                    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

                document.getElementById('convertBtn').disabled = true;
                document.getElementById('convertBtn').innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Mengkonversi...';
                document.getElementById('reconvertNotice').style.display = 'none';

                const filesToConvert = this.files.filter(f => !f.converted || f.needsReconvert);

                for (let i = 0; i < filesToConvert.length; i++) {
                    const fileObj = filesToConvert[i];
                    await this.convertSingleFile(fileObj);
                }

                this.lastConvertedQuality = this.quality;
                this.saveToStorage();

                document.getElementById('convertBtn').innerHTML = '<i class="bx bx-check"></i> Selesai';
                document.getElementById('convertBtn').className = 'btn btn-primary';

                setTimeout(() => {
                    document.getElementById('convertBtn').innerHTML = '<i class="bx bx-refresh"></i> Konversi ke WebP';
                    document.getElementById('convertBtn').disabled = false;
                }, 2000);
            }

            async convertSingleFile(fileObj) {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    img.onload = () => {
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;

                        // Simulate progress
                        let progress = 0;
                        const progressInterval = setInterval(() => {
                            progress += 10;
                            fileObj.progress = Math.min(progress, 90);
                            this.updateUI();
                        }, 50);

                        ctx.drawImage(img, 0, 0);

                        canvas.toBlob((blob) => {
                            clearInterval(progressInterval);
                            fileObj.progress = 100;
                            fileObj.webpBlob = blob;
                            fileObj.webpSize = blob.size;
                            fileObj.converted = true;
                            fileObj.needsReconvert = false;
                            fileObj.convertedAt = new Date().toISOString();
                            fileObj.convertedQuality = this.quality;

                            this.updateUI();
                            resolve();
                        }, 'image/webp', this.quality);
                    };

                    img.src = URL.createObjectURL(fileObj.file);
                });
            }

            downloadSingle(fileId) {
                const fileObj = this.files.find(f => f.id == fileId);
                if (!fileObj || !fileObj.converted || fileObj.needsReconvert) return;

                const link = document.createElement('a');
                link.href = URL.createObjectURL(fileObj.webpBlob);
                link.download = fileObj.name.replace(/\.[^/.]+$/, ".webp");
                link.click();
            }

            async downloadAllAsZip() {
                if (this.convertedFiles.length === 0) return;

                document.getElementById('downloadAllBtn').innerHTML = '<i class="bx bx-loader-alt bx-spin"></i> Membuat ZIP...';
                document.getElementById('downloadAllBtn').disabled = true;

                const zip = new JSZip();

                this.convertedFiles.forEach(fileObj => {
                    const fileName = fileObj.name.replace(/\.[^/.]+$/, ".webp");
                    zip.file(fileName, fileObj.webpBlob);
                });

                try {
                    const zipBlob = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);
                    link.download = `converted_webp_${new Date().getTime()}.zip`;
                    link.click();

                    this.showMessage('File ZIP berhasil diunduh!', 'success');
                } catch (error) {
                    this.showMessage('Gagal membuat file ZIP', 'error');
                } finally {
                    document.getElementById('downloadAllBtn').innerHTML = '<i class="bx bx-package"></i> Download Semua ZIP';
                    document.getElementById('downloadAllBtn').disabled = false;
                }
            }

            clearAll() {
                if (confirm('Apakah Anda yakin ingin menghapus semua file? Data yang tersimpan akan hilang.')) {
                    this.files = [];
                    this.convertedFiles = [];
                    this.lastConvertedQuality = null;
                    document.getElementById('fileInput').value = '';
                    document.getElementById('reconvertNotice').style.display = 'none';
                    localStorage.removeItem('webp_converter_data');
                    this.updateUI();
                    this.showMessage('Semua file berhasil dihapus', 'success');
                }
            }

            saveToStorage() {
                try {
                    const dataToSave = {
                        files: this.files.map(f => ({
                            id: f.id,
                            name: f.name,
                            originalSize: f.originalSize,
                            converted: f.converted,
                            webpSize: f.webpSize,
                            progress: f.progress,
                            convertedAt: f.convertedAt,
                            convertedQuality: f.convertedQuality,
                            needsReconvert: f.needsReconvert,
                            // Store file as base64 for persistence
                            fileData: null // We'll handle this separately due to size constraints
                        })),
                        lastConvertedQuality: this.lastConvertedQuality,
                        quality: this.quality
                    };

                    // Save basic data first
                    localStorage.setItem('webp_converter_data', JSON.stringify(dataToSave));

                    // Save converted WebP blobs separately
                    this.files.forEach((f, index) => {
                        if (f.converted && f.webpBlob) {
                            try {
                                const reader = new FileReader();
                                reader.onload = () => {
                                    localStorage.setItem(`webp_blob_${f.id}`, reader.result);
                                };
                                reader.readAsDataURL(f.webpBlob);
                            } catch (error) {
                                console.warn('Failed to save blob for file:', f.name);
                            }
                        }
                    });

                } catch (error) {
                    console.warn('Failed to save to localStorage:', error);
                    this.showMessage('Peringatan: Data tidak dapat disimpan ke storage lokal', 'error');
                }
            }

            loadFromStorage() {
                try {
                    const savedData = localStorage.getItem('webp_converter_data');
                    if (!savedData) return;

                    const data = JSON.parse(savedData);

                    this.lastConvertedQuality = data.lastConvertedQuality;
                    this.quality = data.quality || 0.95;

                    // Update quality slider
                    document.getElementById('qualitySlider').value = this.quality;
                    document.getElementById('qualityValue').textContent = this.quality.toFixed(2);

                    if (data.files && data.files.length > 0) {
                        // Note: We can't restore original File objects from localStorage
                        // But we can restore converted WebP data
                        const restoredFiles = [];

                        data.files.forEach(fileData => {
                            if (fileData.converted) {
                                const savedBlob = localStorage.getItem(`webp_blob_${fileData.id}`);
                                if (savedBlob) {
                                    // Convert base64 back to blob
                                    fetch(savedBlob)
                                        .then(res => res.blob())
                                        .then(blob => {
                                            // Create a placeholder file object for display
                                            const placeholderFile = new File([''], fileData.name, { type: 'image/placeholder' });

                                            const fileObj = {
                                                ...fileData,
                                                file: placeholderFile,
                                                webpBlob: blob
                                            };

                                            restoredFiles.push(fileObj);

                                            if (restoredFiles.length === data.files.filter(f => f.converted).length) {
                                                this.files = restoredFiles;
                                                this.updateUI();
                                                this.showStorageRestoreInfo();
                                            }
                                        })
                                        .catch(error => {
                                            console.warn('Failed to restore blob:', error);
                                        });
                                }
                            }
                        });
                    }

                } catch (error) {
                    console.warn('Failed to load from localStorage:', error);
                }
            }

            showStorageInfo() {
                this.showMessage('üíæ Data disimpan otomatis ke storage lokal browser Anda untuk keamanan dan kemudahan akses', 'info');
            }

            showStorageRestoreInfo() {
                this.showMessage('üîÑ Data sebelumnya berhasil dipulihkan dari storage lokal. File hasil konversi siap diunduh!', 'success');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            showMessage(message, type) {
                const messagesContainer = document.getElementById('messages');
                const messageDiv = document.createElement('div');

                let className = 'success-message';
                if (type === 'error') className = 'error-message';
                if (type === 'info') className = 'storage-info';

                messageDiv.className = className;
                messageDiv.innerHTML = `<i class='bx ${type === 'error' ? 'bx-error' : type === 'info' ? 'bx-info-circle' : 'bx-check-circle'}'></i> ${message}`;

                messagesContainer.appendChild(messageDiv);

                setTimeout(() => {
                    messageDiv.remove();
                }, type === 'info' ? 8000 : 5000);
            }
        }

        // Initialize converter
        const converter = new WebPConverter();
    </script>
</body>

</html>